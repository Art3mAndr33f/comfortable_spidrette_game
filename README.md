<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# Документация проекта: Пасьянс "Паучиха" (Spider Solitaire)

## Текущее состояние проекта

Реализована полнофункциональная веб-версия пасьянса "Паучиха" с двойной системой управления (мышь + клавиатура) на Vanilla JavaScript с HTML5 Canvas.

## Технический стек

- **Frontend**: HTML5, CSS3, Vanilla JavaScript (ES6+)
- **Графика**: HTML5 Canvas API
- **Среда разработки**: VS Code
- **Анимации**: requestAnimationFrame с easing функциями (ease-out cubic, 300ms)


## Архитектура проекта (MVC pattern)

```
spider-solitaire/
├── index.html
├── css/
│   └── style.css
└── js/
    ├── main.js           # Точка входа, инициализация, игровой цикл
    ├── card.js           # Класс Card (модель карты)
    ├── pile.js           # Класс Pile (вертикальный ряд карт)
    ├── game.js           # Класс Game (игровая логика)
    ├── renderer.js       # Класс Renderer (отрисовка Canvas)
    ├── input.js          # Класс InputManager (управление)
    └── animation.js      # Класс AnimationManager (анимации)
```


## Правила игры (согласно Spider Solitaire)

### Начальная расстановка

- 52 карты из одной колоды
- 7 вертикальных рядов (пилов): 1, 2, 3, 4, 5, 6, 7 карт (всего 28 карт)
- Верхняя карта в каждом ряду открыта, остальные закрыты
- Оставшиеся 24 карты в колоде для раздачи


### Цель игры

Собрать **4 нисходящие последовательности** (К→Т) **одной масти**. При сборе полной последовательности она автоматически удаляется.

### Правила перемещения

- **Перемещаются только одномастные последовательности** (ключевое правило!)
- На карту можно положить карту на единицу меньше по рангу (без учета масти)
- На пустое место можно положить **любую карту или последовательность**
- После снятия карты следующая открывается автоматически


### Раздача карт

- По одной карте на каждый из 7 рядов
- Перед раздачей все ряды должны быть заполнены (нет пустых мест)


### Варианты сложности

- **1 масть**: Только черви (♥) - легкий режим
- **2 масти**: Черви (♥) и пики (♠) - средний режим (контрастные цвета)
- **4 масти**: Все масти - сложный режим


## Реализованный функционал

### Управление мышью

- **Одиночный клик**: Автоматическое перемещение одномастной последовательности на оптимальное место
- **Двойной клик**: Ручной выбор карт для перетаскивания
- **Перетаскивание**: Drag \& drop выбранных карт
- **Подсветка**: Оранжевая рамка вокруг выбранных карт


### Управление клавиатурой

- **←→**: Переход между пилами (фокус на последнюю карту)
- **↑↓**: Перемещение по картам в текущем пиле
- **Пробел**: Выбор/перемещение карт
- **Enter**: Автоматическое перемещение с текущей позиции
- **D / В**: Раздать новые карты
- **, / Б**: Undo (отмена хода)
- **. / Ю**: Redo (возврат хода)
- **Escape**: Отмена выбора
- **Подсветка**: Синяя пунктирная рамка вокруг фокуса


### UI элементы

- Счетчик ходов
- Таймер игры (формат M:SS)
- Селектор сложности (1/2/4 масти)
- Кнопки: "Раздать", "Новая игра", "Отменить", "Вернуть"
- Информационная панель: карты в колоде, собранные последовательности
- Подсказки по управлению


### Система истории (Undo/Redo)

Двустековая архитектура:

- **past[]**: История действий для отмены
- **future[]**: Очищенные действия для возврата
- Типы действий: `'move'` (перемещение) и `'deal'` (раздача)
- При новом действии future очищается


## Ключевые классы и методы

### Card

```javascript
- getRankName()           // '2'-'10', 'В', 'Д', 'К', 'Т'
- getSuitSymbol()         // '♥', '♦', '♣', '♠'
- getSuitColor()          // Красный (#d32f2f) или черный
- canPlaceOn(otherCard)   // Проверка возможности размещения
- isSequenceWith(other)   // Проверка одномастной последовательности
```


### Pile

```javascript
- cardOffset = 35px       // Вертикальный отступ между картами
- addCard(card)
- addCards(cards)
- removeCardsFrom(index)
- getTopCard()
- getSameSuitSequenceFrom(index)  // Получить одномастную последовательность
- checkForCompletedSequence()     // Проверка К→Т одной масти
- getFaceUpStartIndex()           // Индекс первой открытой карты
- getLastCardIndex()              // Индекс последней карты
```


### Game

```javascript
- initGame()                      // Инициализация новой игры
- dealCards()                     // Раздача 7 карт
- moveCards(from, idx, to, anim)  // Перемещение с анимацией
- findBestMoveForCards(pile, idx) // Автопоиск оптимального хода
- checkForCompletedSequences()    // Проверка и удаление К→Т
- undo() / redo()                 // Отмена/возврат
- cleanup()                       // Очистка таймера
```


### Renderer

```javascript
- cardWidth = 100px
- cardHeight = 140px
- draw()                          // Основная отрисовка
- drawCard(card, isFullyVisible)  // Отрисовка карты
- setSelection(pile, index)       // Установка выбора мышью
- setKeyboardFocus(pile, index)   // Установка фокуса клавиатуры
- clearKeyboardFocus()            // Сброс фокуса (при работе мышью)
```


### AnimationManager

```javascript
- animateCardMove(card, x, y, duration, callback)
- update(timestamp)               // Обновление анимаций
- hasActiveAnimations()           // Проверка активных анимаций
```


### InputManager

```javascript
- Обработка mousedown/mousemove/mouseup
- Обработка keydown
- Логика одиночного/двойного клика (300ms задержка)
- Автоматический сброс клавиатурной подсветки при работе мышью
```


## Визуальный дизайн

### Цветовая схема

- Фон игрового поля: `#1b5e20` (темно-зеленый)
- Карты: белые с тенями
- Рубашка карт: градиент синего (`#1565c0`)
- Масти: красные (`#d32f2f`) для ♥♦, черные для ♣♠
- Подсветка выбора: `#ff9800` (оранжевый)
- Подсветка клавиатуры: `#2196f3` (синий, пунктир)


### Особенности отрисовки

- Карты отрисовываются с вертикальным смещением 35px
- Верхняя часть карты (ранг + масть) всегда видна
- Полная карта показывает большой символ масти в центре
- Закрытые карты имеют узор из 5 вложенных прямоугольников


## Известные особенности

1. **Одномастная последовательность**: Метод `getSameSuitSequenceFrom()` строго проверяет, что все карты одной масти. Если встречается другая масть, возвращает только первую карту или null.
2. **Автоперемещение**: Приоритеты поиска:
    - Карта с рангом на 1 больше (6 на 7)
    - Пустое место
3. **Таймер**: Корректно очищается через `cleanup()` при создании новой игры и выгрузке страницы.
4. **Кнопки disabled**: Состояние кнопок Undo/Redo/Deal обновляется автоматически через `updateStats()`.
5. **Анимации блокируют ввод**: Во время анимации клики и нажатия клавиш игнорируются.
6. **Переключение режимов управления**: При работе мышью автоматически сбрасывается клавиатурная подсветка.

## Точки для будущих улучшений

- Добавить звуковые эффекты
- Реализовать систему подсказок (hint)
- Добавить автоматическое завершение игры
- Статистика игр (процент побед)
- Сохранение игры в localStorage
- Адаптивный дизайн для мобильных устройств
- Темная/светлая тема
- Настройки скорости анимации
- Режим "детская паучиха" (смешанные масти в последовательностях)


## Запуск проекта

Просто откройте `index.html` в современном браузере (Chrome, Firefox, Safari, Edge). Не требует веб-сервера или дополнительных зависимостей.

***

**Используйте этот документ для продолжения разработки в новом чате. Весь код полностью рабочий и протестирован.**
<span style="display:none">[^1][^10][^2][^3][^4][^5][^6][^7][^8][^9]</span>

<div align="center">⁂</div>

[^1]: https://razlozhi.ru/patience-spiderette2suits

[^2]: https://durbetsel.ru/3_pausiha.htm

[^3]: http://www.lightst.ru/card/Solitaire/pausiha.htm

[^4]: https://aif.ru/society/people/pasyans-pauk-pochemu-tak-nazyvaetsya-i-kak-igrat

[^5]: https://ru.wikihow.com/раскладывать-пасьянс

[^6]: https://www.min2win.ru/game/pasians-pauk.html

[^7]: https://pasyansklassica.ru/pauchiha-1-mast/

[^8]: https://yandex.ru/games/app/295177

[^9]: https://plarium.com/ru/blog/solitaire/

[^10]: https://ollgames.ru/pauchixa-4-masti/

